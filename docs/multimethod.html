<!DOCTYPE html>  <html> <head>   <title>multimethod.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               multimethod.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>multimethod.js 0.1.0</p>

<p>(c) 2011 Kris Jordan</p>

<p><code>multimethod</code> is freely distributable under the MIT license.
For details and documentation: 
<a href="http://krisjordan.com/multimethod-js">http://krisjordan.com/multimethod-js</a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Multimethods are a functional programming control structure for dispatching 
function calls with user-defined criteria that can be changed at run time.
Inspired by clojure's multimethods, multimethod.js provides an alternative to
classical, prototype-chain based polymorphism.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Internal Utility Functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>No operation function used by default by <code>default</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">noop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Identity <code>dispatch</code> function. Default value of <code>dispatch</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">identity</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span><span class="p">;</span> <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>A <code>method</code> in <code>multimethod</code> is a (match value, function) pair stored in
an array. <code>indexOf</code> takes a value and array of methods and returns the 
index of the method whose value is equal to the first argument. If no 
match is found, false is returned.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">indexOf</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">methods</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">methods</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">matches</span>  <span class="o">=</span> <span class="nx">methods</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">isEqual</span><span class="p">(</span><span class="nx">matches</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Given a dispatch <code>value</code> and array of <code>method</code>s, return the function 
of the <code>method</code> whose match value corresponds to a dispatch value.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">methods</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">indexOf</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">methods</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">index</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">methods</span><span class="p">[</span><span class="nx">index</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Simple, consistent helper that returns a native value or invokes a function
and returns its return value. Used by <code>when</code> and <code>default</code> allowing
short-hand notation for returning values rather than calling functions.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">toValue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">subject</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">subject</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">subject</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Plucking a single property value from an object in <code>dispatch</code> is commonly
used. The internal <code>pluck</code> function returns a function suitable for use
by <code>dispatch</code> for just that purpose.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">pluck</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>Implementation</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p><code>multimethod</code> is a higher-order function that returns a closure with 
methods to control its behavior.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">multimethod</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dispatch</span><span class="p">)</span> <span class="p">{</span> </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h3>Private Properties</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p><code>_dispatch</code> holds either a dispatch function or a string 
corresponding to the property name whose value will be plucked 
and used as the <code>dispatch</code> criteria.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">_dispatch</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p><code>_methods</code> is a an array of <code>method</code> arrays. A <code>method</code> is
[ matchValue, implementation ].</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">_methods</span>   <span class="o">=</span> <span class="p">[],</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><code>_default</code> is the fallback method when a <code>multimethod</code> is called
and matches no other method.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">_default</span>   <span class="o">=</span> <span class="nx">noop</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>The fundamental control flow of the <code>multimethod</code> is implemented
in <code>_lookup</code>. First we invoke the dispatch function, this gives
us our match criteria. Then we match a method based on the criteria
or return the default method.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">_lookup</span>    <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">criteria</span>    <span class="o">=</span> <span class="nx">_dispatch</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">),</span>
                <span class="nx">method</span>      <span class="o">=</span> <span class="nx">match</span><span class="p">(</span><span class="nx">criteria</span><span class="p">,</span> <span class="nx">_methods</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">method</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">method</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">_default</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>The result of calling <code>multimethod</code>'s "factory" function is this function.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">returnFn</span>  <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">_lookup</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">toValue</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h3>Member Methods / API</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p><code>dispatch</code> is the accessor to the <code>multimethod</code>'s <code>_dispatch</code> function.
When called with a string we create an anonymous pluck function as a 
shorthand.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">returnFn</span><span class="p">[</span><span class="s1">&#39;dispatch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dispatch</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">dispatch</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">_dispatch</span> <span class="o">=</span> <span class="nx">dispatch</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">dispatch</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">_dispatch</span> <span class="o">=</span> <span class="nx">pluck</span><span class="p">(</span><span class="nx">dispatch</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="s2">&quot;dispatch requires a function or a string.&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>If <code>multimethod</code> is called/"constructed" with a <code>dispatch</code> value we go ahead and set
it up here. Otherwise <code>dispatch</code> is the <code>identity</code> function.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">returnFn</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="nx">dispatch</span> <span class="o">||</span> <span class="nx">identity</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p><code>when</code> introduces new <code>method</code>s to a <code>multimethod</code>. If the
<code>matchValue</code> has already been registered the new method will
overwrite the old method.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">returnFn</span><span class="p">[</span><span class="s1">&#39;when&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">matchValue</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">indexOf</span><span class="p">(</span><span class="nx">matchValue</span><span class="p">,</span> <span class="nx">_methods</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">index</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">_methods</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">matchValue</span><span class="p">,</span> <span class="nx">fn</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">_methods</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">matchValue</span><span class="p">,</span> <span class="nx">fn</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p><code>remove</code> will unregister a <code>method</code> based on matchValue</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">returnFn</span><span class="p">[</span><span class="s1">&#39;remove&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">matchValue</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">indexOf</span><span class="p">(</span><span class="nx">matchValue</span><span class="p">,</span> <span class="nx">_methods</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">index</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">_methods</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p><code>default</code> is an accessor to control the <code>_default</code>, fallback method
that is called when no match is found when the <code>multimethod</code> is 
invoked and dispatched.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">returnFn</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">_default</span> <span class="o">=</span> <span class="nx">method</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Our <code>multimethod</code> instance/closure is fully setup now, return!</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">returnFn</span><span class="p">;</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>The following snippet courtesy of underscore.js.
Export <code>multimethod</code> to the window/exports namespace.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">module</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">exports</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">multimethod</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">exports</span><span class="p">.</span><span class="nx">multimethod</span> <span class="o">=</span> <span class="nx">multimethod</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;multimethod&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">multimethod</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">[</span><span class="s1">&#39;multimethod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">multimethod</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="nx">multimethod</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="s1">&#39;0.1.0&#39;</span><span class="p">;</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 